<!-- === U4S Chat Widget — Flexbe embed === -->
<style>
  :root{
    --u4s-primary:#C63C3C;       /* основной цвет бренда */
    --u4s-primary-ghost:#FBE9E9; /* светлый фон */
    --u4s-text:#1f2937;
    --u4s-bg:#ffffff;
  }
  #u4s-fab{
    position:fixed; right:18px; bottom:18px; z-index:2147483000;
    width:64px; height:64px; border-radius:50%; background:var(--u4s-primary);
    box-shadow:0 10px 25px rgba(0,0,0,.16), inset 0 0 0 2px rgba(255,255,255,.25);
    display:flex; align-items:center; justify-content:center; color:#fff; cursor:pointer;
    transition:transform .18s ease, box-shadow .18s ease, background .2s;
  }
  #u4s-fab:hover{ transform:translateY(-1px); box-shadow:0 14px 30px rgba(0,0,0,.2) }
  #u4s-fab:active{ transform:translateY(0) scale(.98) }
  #u4s-fab svg{ width:28px; height:28px }
  #u4s-chat{
    position:fixed; right:18px; bottom:92px; z-index:2147483000; width:360px;
    max-width:calc(100vw - 24px); max-height:72vh; border-radius:20px; overflow:hidden;
    box-shadow:0 18px 50px rgba(0,0,0,.25); background:var(--u4s-bg); display:none; flex-direction:column;
    border:1px solid rgba(0,0,0,.06);
  }
  @media (max-width:480px){ #u4s-chat{ right:12px; bottom:88px; width:calc(100vw - 24px); max-height:76vh } #u4s-fab{ right:12px; bottom:12px } }
  #u4s-head{ background:linear-gradient(180deg, var(--u4s-primary), #A82828); color:#fff; padding:14px 16px; display:flex; align-items:center; gap:10px }
  #u4s-head .u4s-avatar{ width:32px; height:32px; border-radius:50%; background:#fff2; display:grid; place-items:center; box-shadow:inset 0 0 0 1px #ffffff33 }
  #u4s-head .u4s-title{ font:600 15px/1.1 system-ui, -apple-system, "Segoe UI", Roboto, Arial }
  #u4s-head .u4s-sub{ font:12px/1.2 system-ui, -apple-system, "Segoe UI"; opacity:.9 }
  #u4s-scroll{ padding:14px 12px; overflow:auto; background:var(--u4s-primary-ghost) }
  .u4s-msg{ max-width:84%; margin:6px 0; padding:10px 12px; border-radius:16px; font:14px/1.45 system-ui, -apple-system,"Segoe UI"; color:var(--u4s-text); background:#fff; box-shadow:0 1px 2px rgba(0,0,0,.04) }
  .u4s-me{ margin-left:auto; background:#fff; border:1px solid rgba(0,0,0,.06) }
  .u4s-bot{ background:#fff }
  .u4s-time{ font-size:11px; opacity:.6; margin-top:4px }
  .u4s-typing{ display:flex; gap:6px; align-items:center; margin:6px 0 }
  .u4s-dot{ width:6px; height:6px; border-radius:50%; background:#bbb; animation:u4s-bounce 1s infinite ease-in-out }
  .u4s-dot:nth-child(2){ animation-delay:.15s } .u4s-dot:nth-child(3){ animation-delay:.3s }
  @keyframes u4s-bounce{0%,80%,100%{transform:scale(0.6);opacity:.5}40%{transform:scale(1);opacity:1}}
  #u4s-inputbar{ display:flex; gap:8px; padding:10px; background:#fff; border-top:1px solid rgba(0,0,0,.06) }
  #u4s-q{ flex:1; border:1px solid rgba(0,0,0,.12); border-radius:999px; padding:10px 14px; outline:none; font:14px system-ui; transition:border .2s, box-shadow .2s }
  #u4s-q:focus{ border-color:var(--u4s-primary); box-shadow:0 0 0 3px rgba(198,60,60,.18) }
  #u4s-send{ min-width:44px; border-radius:999px; border:0; background:var(--u4s-primary); color:#fff; font:600 14px system-ui; padding:0 14px; cursor:pointer; transition:opacity .15s, transform .15s }
  #u4s-send:disabled{ opacity:.6; cursor:not-allowed }
</style>

<div id="u4s-fab" aria-label="Открыть чат" role="button" tabindex="0">
  <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
    <path d="M20 14.5c0 1.9-1.6 3.5-3.5 3.5H9l-5 4V6.5C4 4.6 5.6 3 7.5 3h9C18.4 3 20 4.6 20 6.5v8z" stroke="white" stroke-width="1.6" fill="none"/>
  </svg>
</div>

<div id="u4s-chat" aria-live="polite" aria-label="Чат с помощником">
  <div id="u4s-head">
    <div class="u4s-avatar">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="#fff" aria-hidden="true">
        <circle cx="7" cy="14" r="3"/><circle cx="12" cy="11" r="3"/><circle cx="17" cy="14" r="3"/>
      </svg>
    </div>
    <div>
      <div class="u4s-title">Помощник Усадьбы</div>
      <div class="u4s-sub">Задайте вопрос — отвечу по базе знаний</div>
    </div>
  </div>

  <div id="u4s-scroll"></div>

  <form id="u4s-inputbar">
    <input id="u4s-q" type="text" placeholder="Напишите сообщение…" autocomplete="off" />
    <button id="u4s-send" type="submit">Отпр.</button>
  </form>
</div>

<script>
(function(){
  const FN_URL = "https://ai-chatbot-u4s-karinausadba.amvera.io"; // ← твоя функция

  const $fab = document.getElementById('u4s-fab');
  const $chat = document.getElementById('u4s-chat');
  const $scroll = document.getElementById('u4s-scroll');
  const $form = document.getElementById('u4s-inputbar');
  const $q = document.getElementById('u4s-q');

  const KEY = 'u4s_history_v1';
  let history = [];
  try{ history = JSON.parse(localStorage.getItem(KEY) || '[]'); }catch(_){}
  history.forEach(addBubble); scrollToEnd();

  function toggleChat(open){
    const show = open ?? ($chat.style.display==='none' || !$chat.style.display);
    $chat.style.display = show ? 'flex' : 'none';
    if (show) setTimeout(()=> $q.focus(), 50);
  }
  document.getElementById('u4s-fab').addEventListener('click', ()=>toggleChat(true));
  document.getElementById('u4s-fab').addEventListener('keydown', e=>{ if(e.key==='Enter' || e.key===' ') toggleChat(true); });

  if(history.length===0){
    addBubble({role:'bot', text:'Здравствуйте! Я помогу с вопросами про проживание, ресторан «Калина Красная», баню, контакты и др.'});
    persist();
  }

  $form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const text = ($q.value || '').trim();
    if(!text) return;
    addBubble({role:'me', text});
    $q.value=''; $q.focus();
    persist();

    const typing = addTyping();
    try{
      const res = await fetch(FN_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ question: text })
      });
      const data = await res.json().catch(()=> ({}));
      removeTyping(typing);

      let answer = data?.answer || data?.message || data?.response || '';
      if(!answer){ answer = 'Извините, сейчас не могу ответить. Попробуйте позже.'; }
      addBubble({role:'bot', text: answer});
      persist();
    }catch(err){
      removeTyping(typing);
      addBubble({role:'bot', text:'Упс! Не удалось связаться с сервером.'});
      persist();
    }
  });

  function addBubble({role, text}){
    const wrap = document.createElement('div');
    wrap.className='u4s-msg '+(role==='me'?'u4s-me':'u4s-bot');
    wrap.innerHTML = sanitize(text).replace(/\n/g,'<br>');
    $scroll.appendChild(wrap);
    const time = document.createElement('div');
    time.className='u4s-time';
    time.textContent = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    $scroll.appendChild(time);
    scrollToEnd();
  }
  function addTyping(){
    const row = document.createElement('div'); row.className='u4s-typing';
    row.innerHTML = '<div class="u4s-dot"></div><div class="u4s-dot"></div><div class="u4s-dot"></div>';
    $scroll.appendChild(row); scrollToEnd();
    return row;
  }
  function removeTyping(node){ if(node && node.parentNode) node.parentNode.removeChild(node); }
  function scrollToEnd(){ $scroll.scrollTop = $scroll.scrollHeight+999; }
  function persist(){
    const msgs = [...document.querySelectorAll('.u4s-msg')].map(n=>({role:n.classList.contains('u4s-me')?'me':'bot', text:n.innerText}));
    localStorage.setItem(KEY, JSON.stringify(msgs));
  }
  function sanitize(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  // авто-открытие ?chat=open
  try{ if(new URL(location.href).searchParams.get('chat')==='open') toggleChat(true); }catch(_){}
})();
</script>
<!-- === /U4S Chat Widget === -->
