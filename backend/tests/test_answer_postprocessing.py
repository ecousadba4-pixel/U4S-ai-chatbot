import textwrap

from app.chat.formatting import detect_detail_mode, postprocess_answer


def test_brief_mode_limits_lines_for_short_question():
    user_text = "—É –≤–∞—Å –µ—Å—Ç—å –±–∞–Ω—è?"
    long_answer = textwrap.dedent(
        """
        –î–∞, –±–∞–Ω—è –¥–æ—Å—Ç—É–ø–Ω–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å —Å 10:00 –¥–æ 22:00. –í–º–µ—â–∞–µ—Ç –¥–æ 6 —á–µ–ª–æ–≤–µ–∫, –µ—Å—Ç—å –≤–µ–Ω–∏—á–∫–∏ –∏ –∑–æ–Ω–∞ –æ—Ç–¥—ã—Ö–∞.
        ‚Ä¢ –°—Ç–æ–∏–º–æ—Å—Ç—å —á–∞—Å–∞ ‚Äî 2000 ‚ÇΩ, –º–∏–Ω–∏–º—É–º 2 —á–∞—Å–∞.
        ‚Ä¢ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –ø–æ–ª–æ—Ç–µ–Ω—Ü–∞, —á–∞–π –∏ –º–µ–¥–æ–≤—ã–µ –º–∞—Å–∫–∏. –ú–æ–∂–Ω–æ –∑–∞–∫–∞–∑–∞—Ç—å –æ–±–ª–∏–≤–∞–Ω–∏–µ.
        ‚Ä¢ –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç –∫–æ—Ä–ø—É—Å–∞ ‚Äî 150 –º–µ—Ç—Ä–æ–≤, –µ—Å—Ç—å –ø–∞—Ä–∫–æ–≤–∫–∞ —Ä—è–¥–æ–º.
        –ö–æ–Ω—Ç–∞–∫—Ç—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: +7 999 000-00-00, –∑–∞–ø–∏—Å—å –∑–∞—Ä–∞–Ω–µ–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞.
        –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞ –¥–µ–Ω—å, –æ—Ç–º–µ–Ω–∞ –∑–∞ 3 —á–∞—Å–∞ –±–µ–∑ —à—Ç—Ä–∞—Ñ–æ–≤.
        """
    ).strip()

    answer = postprocess_answer(long_answer, mode="detail" if detect_detail_mode(user_text) else "brief")

    assert len(answer.splitlines()) <= 5


def test_detail_mode_keeps_full_text_when_requested():
    user_text = "–ø–æ–¥—Ä–æ–±–Ω–µ–µ –ø—Ä–æ –±–∞–Ω—é –∏ —Ü–µ–Ω—ã"
    detailed_answer = textwrap.dedent(
        """
        –ë–∞–Ω—è —Ä–∞–±–æ—Ç–∞–µ—Ç —Å 10:00 –¥–æ 22:00, –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –¥–æ 6 —á–µ–ª–æ–≤–µ–∫.
        –¶–µ–Ω—ã:
        ‚Ä¢ –ß–∞—Å ‚Äî 2000 ‚ÇΩ, –º–∏–Ω–∏–º—É–º 2 —á–∞—Å–∞.
        ‚Ä¢ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏: –≤–µ–Ω–∏–∫ 300 ‚ÇΩ, –ø–æ–ª–æ—Ç–µ–Ω—Ü–µ 150 ‚ÇΩ, —Å–∞–º–æ–≤–∞—Ä —Å —Ç—Ä–∞–≤—è–Ω—ã–º —á–∞–µ–º 600 ‚ÇΩ.

        –ß—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ: –ø–∞—Ä–Ω–∞—è, –¥—É—à, –∫–æ–º–Ω–∞—Ç–∞ –æ—Ç–¥—ã—Ö–∞ —Å –∫–∞–º–∏–Ω–æ–º.
        –£—Å–ª–æ–≤–∏—è: –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ 30%, –æ—Ç–º–µ–Ω–∞ –∑–∞ 3 —á–∞—Å–∞ –±–µ–∑ —à—Ç—Ä–∞—Ñ–∞.
        """
    ).strip()

    answer = postprocess_answer(detailed_answer, mode="detail" if detect_detail_mode(user_text) else "brief")

    assert len(answer.splitlines()) >= len(detailed_answer.splitlines())
    assert "–ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞" in answer.lower()


def test_booking_calculation_text_not_shortened():
    answer = """–ù–∞ –¥–∞—Ç—ã 20.01‚Äì22.01 (2 –Ω–æ—á–∏) –¥–ª—è 2 –≤–∑—Ä–æ—Å–ª—ã—Ö –¥–æ—Å—Ç—É–ø–Ω—ã –≤–∞—Ä–∏–∞–Ω—Ç—ã:
    \n\nüè† –°—Ç–∞–Ω–¥–∞—Ä—Ç ‚Äî 12 000 ‚ÇΩ\n–ü–æ–∫–∞–∑–∞–Ω—ã –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã –ø–æ –∫–∞–∂–¥–æ–º—É —Ç–∏–ø—É –Ω–æ–º–µ—Ä–∞."""

    processed = postprocess_answer(answer, mode="detail")

    assert processed.endswith("–ü–æ–∫–∞–∑–∞–Ω—ã –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã –ø–æ –∫–∞–∂–¥–æ–º—É —Ç–∏–ø—É –Ω–æ–º–µ—Ä–∞.")
